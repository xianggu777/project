<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI助手紧急修复版本</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>AI助手</h2>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <nav class="menu">
                <div class="menu-item" data-tab="chat">
                    <i class="fas fa-comments"></i>
                    <span>智能对话</span>
                </div>
                <div class="menu-item" data-tab="image">
                    <i class="fas fa-image"></i>
                    <span>图片识别</span>
                </div>
                <div class="menu-item active" data-tab="resources">
                    <i class="fas fa-folder-open"></i>
                    <span>资源库</span>
                </div>
                <div class="menu-item" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>设置</span>
                </div>
            </nav>
        </div>

        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">资源库</h1>
            </div>

            <div class="tab-content" id="resources-tab">
                <div class="resources-container">
                    <div class="resources-header">
                        <h2>文档资源库 (修复版本)</h2>
                        <div class="resources-actions">
                            <button class="btn-primary" id="uploadBtn">
                                <i class="fas fa-upload"></i> 上传文档
                            </button>
                            <button class="btn-secondary" id="newFolderBtn">
                                <i class="fas fa-folder-plus"></i> 新建文件夹
                            </button>
                        </div>
                    </div>

                    <div class="resources-search">
                        <div class="search-container">
                            <input type="text" id="resourcesSearchInput" placeholder="搜索文档...">
                            <button class="btn-primary" id="resourcesSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="filter-container">
                            <select id="typeFilter">
                                <option value="">所有类型</option>
                                <option value="pdf">PDF文档</option>
                                <option value="doc">Word文档</option>
                                <option value="txt">文本文件</option>
                                <option value="md">Markdown</option>
                                <option value="image">图片</option>
                            </select>
                            <select id="categoryFilter">
                                <option value="">所有分类</option>
                                <option value="study">学习资料</option>
                                <option value="work">工作文档</option>
                                <option value="research">研究论文</option>
                                <option value="personal">个人文档</option>
                            </select>
                            <select id="sortBy">
                                <option value="date">按日期排序</option>
                                <option value="name">按名称排序</option>
                                <option value="size">按大小排序</option>
                                <option value="type">按类型排序</option>
                            </select>
                        </div>
                    </div>

                    <div class="resources-grid" id="resourcesGrid">
                        <div class="resources-empty">
                            <i class="fas fa-folder-open"></i>
                            <h3>紧急修复版本</h3>
                            <p>分类功能已临时禁用以确保应用正常运行</p>
                            <p>基础功能（上传、预览、下载、删除）应该可以正常使用</p>
                            <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-upload"></i> 上传文档
                            </button>
                            <p style="margin-top: 20px; color: #666;">如果问题持续存在，请检查浏览器控制台的错误信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="fileInput" multiple accept="*/*" style="display: none;">

    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // 最小化的应用脚本，确保基本功能可用
        console.log('启动紧急修复版本...');

        // 基础变量
        let resources = [];
        let currentPath = '/';
        let resourceIdCounter = 1;

        // 基础函数
        function showNotification(message, type = 'info') {
            console.log(`通知 (${type}): ${message}`);
            // 简单的通知显示
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                padding: 10px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function loadResources() {
            try {
                const saved = localStorage.getItem('ai-assistant-resources');
                if (saved) {
                    resources = JSON.parse(saved);
                    resourceIdCounter = Math.max(...resources.map(r => r.id || 0), 0) + 1;
                    renderResources();
                } else {
                    // 添加一些示例文档
                    resources = [
                        {
                            id: resourceIdCounter++,
                            name: '示例文档.pdf',
                            type: 'pdf',
                            size: 1024000,
                            path: '/',
                            category: 'study',
                            uploadedAt: new Date().toISOString(),
                            content: '这是一个示例PDF文档'
                        }
                    ];
                    saveResources();
                    renderResources();
                }
                showNotification('资源加载完成', 'success');
            } catch (error) {
                console.error('加载资源失败:', error);
                showNotification('加载资源失败', 'error');
            }
        }

        function saveResources() {
            try {
                localStorage.setItem('ai-assistant-resources', JSON.stringify(resources));
                console.log('资源保存成功');
            } catch (error) {
                console.error('保存资源失败:', error);
                showNotification('保存资源失败', 'error');
            }
        }

        function renderResources() {
            const grid = document.getElementById('resourcesGrid');
            if (!grid) return;

            if (resources.length === 0) {
                grid.innerHTML = `
                    <div class="resources-empty">
                        <i class="fas fa-folder-open"></i>
                        <h3>暂无文档</h3>
                        <p>点击上传按钮或拖拽文件到这里开始上传</p>
                        <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-upload"></i> 上传文档
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';
            resources.forEach(resource => {
                const item = createResourceElement(resource);
                grid.appendChild(item);
            });
        }

        function createResourceElement(resource) {
            const div = document.createElement('div');
            div.className = 'resource-item';
            div.dataset.resourceId = resource.id;

            const formattedSize = formatFileSize(resource.size);

            div.innerHTML = `
                <div class="resource-actions">
                    <button class="resource-action-btn" onclick="previewResource(${resource.id})" title="预览">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="resource-action-btn" onclick="downloadResource(${resource.id})" title="下载">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="resource-action-btn" onclick="deleteResource(${resource.id})" title="删除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="resource-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div class="resource-name">${resource.name}</div>
                <div class="resource-info">
                    <div>${formattedSize}</div>
                    <div>${new Date(resource.uploadedAt).toLocaleDateString()}</div>
                </div>
            `;

            return div;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function previewResource(id) {
            console.log('预览文档:', id);
            showNotification('预览功能暂不可用', 'info');
        }

        function downloadResource(id) {
            console.log('下载文档:', id);
            showNotification('下载功能暂不可用', 'info');
        }

        function deleteResource(id) {
            if (confirm('确定要删除这个文档吗？')) {
                resources = resources.filter(r => r.id !== id);
                saveResources();
                renderResources();
                showNotification('文档已删除', 'success');
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const resource = {
                        id: resourceIdCounter++,
                        name: file.name,
                        type: getFileType(file.name),
                        size: file.size,
                        path: currentPath,
                        category: 'personal',
                        uploadedAt: new Date().toISOString(),
                        content: e.target.result
                    };
                    resources.push(resource);
                    console.log('文件上传成功:', file.name);
                };
                reader.readAsDataURL(file);
            });

            setTimeout(() => {
                saveResources();
                renderResources();
                showNotification(`成功上传 ${files.length} 个文件`, 'success');
            }, 500);
        }

        function getFileType(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'pdf',
                'doc': 'doc',
                'docx': 'docx',
                'txt': 'txt',
                'md': 'md',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image'
            };
            return typeMap[extension] || 'txt';
        }

        // 事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化紧急修复版本...');
            loadResources();

            // 文件上传
            document.getElementById('uploadBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // 菜单切换
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');

                    const tab = this.dataset.tab;
                    if (tab === 'resources') {
                        showNotification('已切换到资源库', 'info');
                    } else {
                        showNotification(`切换到${this.querySelector('span').textContent}功能暂不可用`, 'info');
                    }
                });
            });

            console.log('紧急修复版本初始化完成');
            showNotification('紧急修复版本已启动，分类功能已禁用', 'success');
        });
    </script>
</body>
</html>